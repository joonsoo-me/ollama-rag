{
  "name": "Ollama RAG Prepare & Upsert n8n Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rag/prepare",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "18857250-ffc9-440a-99cf-353c6b64fcc3",
      "name": "WH Prepare",
      "position": [
        -2176,
        -288
      ],
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "rag-prepare-01",
      "onError": "continueRegularOutput",
      "notes": "RAG ì¤€ë¹„ ì—”ë“œí¬ì¸íŠ¸ / RAG Prepare Endpoint\n\ní•œê¸€: POST /rag/prepareë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.\nì…ë ¥ í˜•ì‹:\n{\n  \"query\": \"ê²€ìƒ‰í•  ì§ˆë¬¸\",\n  \"topk\": 12,\n  \"topn\": 5,\n  \"score_threshold\": 0.2,\n  \"session_id\": \"ì„¸ì…˜ID\",\n  \"thread_id\": \"ìŠ¤ë ˆë“œID\"\n}\n\nEnglish: Handles incoming POST requests to /rag/prepare\nInput format:\n{\n  \"query\": \"question to search\",\n  \"topk\": 12,\n  \"topn\": 5,\n  \"score_threshold\": 0.2,\n  \"session_id\": \"session ID\",\n  \"thread_id\": \"thread ID\"\n}"
    },
    {
      "parameters": {
        "jsCode": "// Code v2: return [{ json: {...} }], avoid ?? and ?.\nconst b = $json;\nlet query = '';\nif (typeof b.query === 'string' && b.query.length) {\n  query = b.query;\n} else if (Array.isArray(b.messages) && b.messages.length) {\n  const last = b.messages[b.messages.length - 1] || {};\n  query = (last && typeof last.content === 'string') ? last.content : '';\n}\nquery = String(query || '').slice(0, 4000);\nfunction toNumber(x, defV){ const n = Number(x); return Number.isFinite(n) ? n : defV; }\nconst topk = Math.max(1, Math.min(64, toNumber(b.topk, 12)));\nconst topn = Math.max(1, Math.min(topk, toNumber(b.topn, 5)));\nconst score_threshold = toNumber(b.score_threshold, 0.2);\nconst out = {\n  query: query,\n  topk: topk,\n  topn: topn,\n  score_threshold: score_threshold,\n  session_id: (b.session_id !== undefined && b.session_id !== null) ? b.session_id : null,\n  thread_id: (b.thread_id !== undefined && b.thread_id !== null) ? b.thread_id : null,\n};\nreturn [{ json: out }];"
      },
      "id": "1065380f-0470-4460-8a49-b060552956af",
      "name": "Fn Prepare Defaults",
      "position": [
        -1920,
        -288
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "notes": "ì…ë ¥ ë°ì´í„° ì²˜ë¦¬ ë° ê¸°ë³¸ê°’ ì„¤ì • / Input Processing & Default Values\n\ní•œê¸€:\n- ì¿¼ë¦¬ ì¶”ì¶œ (ì§ì ‘ ë˜ëŠ” ë©”ì‹œì§€ì—ì„œ)\n- topk: ë²¡í„° ê²€ìƒ‰í•  ë¬¸ì„œ ìˆ˜ (1-64, ê¸°ë³¸ê°’: 12)\n- topn: ìµœì¢… ë°˜í™˜í•  ë¬¸ì„œ ìˆ˜ (ê¸°ë³¸ê°’: 5)\n- score_threshold: ìµœì†Œ ìœ ì‚¬ë„ ì ìˆ˜ (ê¸°ë³¸ê°’: 0.2)\n- ì„¸ì…˜/ìŠ¤ë ˆë“œ ID ì²˜ë¦¬\n\nEnglish:\n- Extract query (direct or from messages)\n- topk: number of docs to search (1-64, default: 12)\n- topn: final docs to return (default: 5)\n- score_threshold: minimum similarity score (default: 0.2)\n- Handle session/thread IDs"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.TEI_EMBED_URL + '/embed' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { inputs: [ $json.query ] } }}",
        "options": {}
      },
      "id": "00e53435-ca0a-4ac5-92f4-8ad61d31d10f",
      "name": "HTTP TEI Embed (query)",
      "position": [
        -1680,
        -384
      ],
      "retryOnFail": true,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "onError": "continueRegularOutput",
      "notes": "ì¿¼ë¦¬ ì„ë² ë”© ë³€í™˜ / Query Embedding Conversion\n\ní•œê¸€:\n- TEI (Text Embeddings Inference) ì„œë²„ë¥¼ í†µí•´ ì¿¼ë¦¬ë¥¼ ë²¡í„°ë¡œ ë³€í™˜\n- í™˜ê²½ë³€ìˆ˜ TEI_EMBED_URL í•„ìš”\n- ì…ë ¥: { \"inputs\": [\"ê²€ìƒ‰í•  í…ìŠ¤íŠ¸\"] }\n- ì¶œë ¥: { \"embeddings\": [[ë²¡í„° ë°°ì—´]] }\n\nEnglish:\n- Convert query to vector using TEI server\n- Requires TEI_EMBED_URL environment variable\n- Input: { \"inputs\": [\"text to search\"] }\n- Output: { \"embeddings\": [[vector array]] }"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.QDRANT_URL + '/collections/' + $env.QDRANT_COLLECTION + '/points/search' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { vector: ($json.embeddings && $json.embeddings[0]) ? $json.embeddings[0] : (($json.data && $json.data[0] && $json.data[0].embedding) ? $json.data[0].embedding : []), limit: $items('Fn Prepare Defaults')[0].json.topk, with_payload: true, with_vectors: false } }}",
        "options": {}
      },
      "id": "95a4a371-9ffe-441e-8fb0-df353fd18eea",
      "name": "HTTP Qdrant Search",
      "position": [
        -1440,
        -384
      ],
      "retryOnFail": true,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "onError": "continueRegularOutput",
      "notes": "ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ / Vector Similarity Search\n\ní•œê¸€:\n- Qdrant ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìœ ì‚¬í•œ ë¬¸ì„œ ê²€ìƒ‰\n- í™˜ê²½ë³€ìˆ˜: QDRANT_URL, QDRANT_COLLECTION\n- ì¿¼ë¦¬ ë²¡í„°ì™€ ê°€ì¥ ìœ ì‚¬í•œ topkê°œ ë¬¸ì„œ ë°˜í™˜\n- with_payload: true (ë©”íƒ€ë°ì´í„° í¬í•¨)\n- with_vectors: false (ë²¡í„°ëŠ” ì œì™¸)\n\nEnglish:\n- Search similar documents in Qdrant vector database\n- Environment variables: QDRANT_URL, QDRANT_COLLECTION\n- Returns topk most similar documents to query vector\n- with_payload: true (include metadata)\n- with_vectors: false (exclude vectors)"
    },
    {
      "parameters": {
        "jsCode": "// INPUT: Qdrant search resp\n// OUTPUT: { docs:[{id,text,score}], doc_texts:[...]} in json\nconst res = $json;\nconst arr = Array.isArray(res.result) ? res.result : (Array.isArray(res.results) ? res.results : []);\nconst docs = [];\nconst doc_texts = [];\nfor (const h of arr) {\n  const payload = (h && h.payload) ? h.payload : {};\n  const txt = (payload && typeof payload.text === 'string') ? payload.text : '';\n  if (txt) {\n    const id = (h && h.id !== undefined && h.id !== null) ? h.id : ((payload && payload.id !== undefined) ? payload.id : null);\n    const score = (typeof h.score === 'number') ? h.score : null;\n    docs.push({ id: id, text: String(txt), score: score });\n    doc_texts.push(String(txt));\n  }\n}\nreturn [{ json: { docs: docs, doc_texts: doc_texts } }];"
      },
      "id": "a1f49c9a-38ca-4dbe-b398-1f10fcf2cd00",
      "name": "Fn Doc Collect",
      "position": [
        -1216,
        -384
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "notes": "ê²€ìƒ‰ ê²°ê³¼ ë¬¸ì„œ ìˆ˜ì§‘ / Search Results Collection\n\ní•œê¸€:\n- Qdrant ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ë¬¸ì„œ ì •ë³´ ì¶”ì¶œ\n- docs: [{id, text, score}] í˜•íƒœë¡œ êµ¬ì¡°í™”\n- doc_texts: ì¬ë­í‚¹ìš© í…ìŠ¤íŠ¸ ë°°ì—´\n- ë¹ˆ í…ìŠ¤íŠ¸ëŠ” ì œì™¸\n\nEnglish:\n- Extract document info from Qdrant search results\n- Structure as docs: [{id, text, score}]\n- doc_texts: text array for reranking\n- Exclude empty texts"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.TEI_RERANK_URL + '/rerank' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { query: $items('Fn Prepare Defaults')[0].json.query, documents: $json.doc_texts } }}",
        "options": {}
      },
      "id": "c893180d-d91b-4440-990a-30f148d895be",
      "name": "HTTP TEI Rerank",
      "position": [
        -992,
        -384
      ],
      "retryOnFail": true,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "onError": "continueRegularOutput",
      "notes": "ë¬¸ì„œ ì¬ë­í‚¹ / Document Reranking\n\ní•œê¸€:\n- TEI ì¬ë­í‚¹ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„œ ê´€ë ¨ì„± ì¬í‰ê°€\n- í™˜ê²½ë³€ìˆ˜ TEI_RERANK_URL í•„ìš”\n- ì¿¼ë¦¬ì™€ ë¬¸ì„œë“¤ì˜ ê´€ë ¨ì„±ì„ ë” ì •í™•í•˜ê²Œ ê³„ì‚°\n- ì…ë ¥: { \"query\": \"ì§ˆë¬¸\", \"documents\": [\"ë¬¸ì„œ1\", \"ë¬¸ì„œ2\"] }\n- ì¶œë ¥: { \"results\": [{\"index\": 0, \"score\": 0.95}] }\n\nEnglish:\n- Re-evaluate document relevance using TEI reranking model\n- Requires TEI_RERANK_URL environment variable\n- More accurate relevance calculation between query and documents\n- Input: { \"query\": \"question\", \"documents\": [\"doc1\", \"doc2\"] }\n- Output: { \"results\": [{\"index\": 0, \"score\": 0.95}] }"
    },
    {
      "parameters": {
        "mode": "combine",
        "options": {}
      },
      "id": "079dea39-73f0-41e9-b7ef-4513ea3a9853",
      "name": "Merge Rerank+Docs",
      "position": [
        -784,
        -384
      ],
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "notes": "ì¬ë­í‚¹ ê²°ê³¼ì™€ ë¬¸ì„œ ì •ë³´ ë³‘í•© / Merge Reranking Results with Document Info\n\ní•œê¸€: ì¬ë­í‚¹ ì ìˆ˜ì™€ ì›ë³¸ ë¬¸ì„œ ì •ë³´ë¥¼ ê²°í•©\nEnglish: Combine reranking scores with original document information"
    },
    {
      "parameters": {
        "mode": "combine",
        "options": {}
      },
      "id": "e6832ff7-ebdd-4b0f-b640-1c390ec3d47f",
      "name": "Merge +Defaults",
      "position": [
        -560,
        -384
      ],
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "notes": "ê¸°ë³¸ê°’ê³¼ ê²°í•© / Merge with Defaults\n\ní•œê¸€: ê¸°ë³¸ ì„¤ì •ê°’(topn, threshold)ê³¼ ë¬¸ì„œ ì •ë³´ë¥¼ ê²°í•©\nEnglish: Combine default settings (topn, threshold) with document info"
    },
    {
      "parameters": {
        "jsCode": "// INPUT: merged defaults + rerank + docs\n// OUTPUT: { context:[...], docRefs:[...] }\nconst j = $json;\nconst docs = Array.isArray(j.docs) ? j.docs : [];\nconst topn = Number.isFinite(Number(j.topn)) ? Number(j.topn) : 5;\nconst thr  = Number.isFinite(Number(j.score_threshold)) ? Number(j.score_threshold) : 0.2;\nlet pairs = [];\nif (Array.isArray(j.results)) {\n  for (const r of j.results) {\n    const idx = (r && (r.index !== undefined || r.documentIndex !== undefined)) ? (r.index !== undefined ? r.index : r.documentIndex) : 0;\n    const sc = (r && (typeof r.score === 'number' || typeof r.relevance === 'number')) ? (typeof r.score === 'number' ? r.score : r.relevance) : 0;\n    const d = docs[idx];\n    if (d) pairs.push({ id: d.id, text: d.text, score: sc });\n  }\n} else if (Array.isArray(j.scores)) {\n  for (let i = 0; i < docs.length && i < j.scores.length; i++) {\n    const sc = Number(j.scores[i]);\n    pairs.push({ id: docs[i].id, text: docs[i].text, score: Number.isFinite(sc) ? sc : 0 });\n  }\n}\npairs = pairs.filter(p => (typeof p.score === 'number' ? p.score : 0) >= thr).sort((a,b)=> b.score - a.score).slice(0, topn);\nreturn [{ json: { context: pairs, docRefs: pairs.map(p => ({ id: p.id, score: p.score })) } }];"
      },
      "id": "555388b8-b89e-4d06-82c0-0047a23e5f04",
      "name": "Fn Zip+Filter (topN, threshold)",
      "position": [
        -336,
        -384
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "notes": "ìµœì¢… ë¬¸ì„œ í•„í„°ë§ ë° ì •ë ¬ / Final Document Filtering & Sorting\n\ní•œê¸€:\n- ì¬ë­í‚¹ ì ìˆ˜ì™€ ì›ë³¸ ë¬¸ì„œ ì •ë³´ ê²°í•©\n- score_threshold ì´ìƒì˜ ë¬¸ì„œë§Œ ì„ íƒ\n- ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬\n- topnê°œ ë¬¸ì„œë§Œ ìµœì¢… ì„ íƒ\n- context: ì „ì²´ ë¬¸ì„œ ì •ë³´\n- docRefs: IDì™€ ì ìˆ˜ë§Œ í¬í•¨í•œ ì°¸ì¡° ì •ë³´\n\nEnglish:\n- Combine reranking scores with original document info\n- Select documents above score_threshold\n- Sort by score in descending order\n- Select only topn documents\n- context: full document information\n- docRefs: reference info with ID and score only"
    },
    {
      "parameters": {
        "options": {
          "responseCode": {
            "values": {
              "responseCode": 200
            }
          }
        }
      },
      "id": "b9335773-902f-4055-a887-fa72fa11a085",
      "name": "Respond Prepare",
      "position": [
        -112,
        -384
      ],
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "onError": "continueRegularOutput",
      "notes": "RAG ì¤€ë¹„ ì‘ë‹µ / RAG Prepare Response\n\ní•œê¸€:\n- ìµœì¢… ê²€ìƒ‰ ê²°ê³¼ë¥¼ JSON í˜•íƒœë¡œ ë°˜í™˜\n- context: LLMì´ ì‚¬ìš©í•  ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸\n- docRefs: ì°¸ì¡°ëœ ë¬¸ì„œë“¤ì˜ IDì™€ ì ìˆ˜\n\nì‘ë‹µ í˜•ì‹:\n{\n  \"context\": [{\"id\": \"doc1\", \"text\": \"ë‚´ìš©\", \"score\": 0.95}],\n  \"docRefs\": [{\"id\": \"doc1\", \"score\": 0.95}]\n}\n\nEnglish:\n- Return final search results in JSON format\n- context: document context for LLM to use\n- docRefs: IDs and scores of referenced documents\n\nResponse format:\n{\n  \"context\": [{\"id\": \"doc1\", \"text\": \"content\", \"score\": 0.95}],\n  \"docRefs\": [{\"id\": \"doc1\", \"score\": 0.95}]\n}"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rag/upsert",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "3e059adf-e7b5-4467-880f-8af783c92b75",
      "name": "WH Upsert",
      "position": [
        -2176,
        176
      ],
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "webhookId": "rag-upsert-01",
      "onError": "continueRegularOutput",
      "notes": "RAG ì—…ì„œíŠ¸ ì—”ë“œí¬ì¸íŠ¸ / RAG Upsert Endpoint\n\ní•œê¸€: POST /rag/upsertë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.\nLLMì˜ ë‹µë³€ì„ ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì—¬ í–¥í›„ RAGì— í™œìš©\n\nì…ë ¥ í˜•ì‹:\n{\n  \"answer\": \"LLMì´ ìƒì„±í•œ ë‹µë³€\",\n  \"question\": \"ì›ë³¸ ì§ˆë¬¸\",\n  \"refs\": [ì°¸ì¡°ëœ ë¬¸ì„œ ì •ë³´],\n  \"session_id\": \"ì„¸ì…˜ID\",\n  \"thread_id\": \"ìŠ¤ë ˆë“œID\",\n  \"id\": \"ë‹µë³€ ê³ ìœ ID (ì„ íƒì‚¬í•­)\"\n}\n\nEnglish: Handles incoming POST requests to /rag/upsert\nStores LLM answers in vector database for future RAG use\n\nInput format:\n{\n  \"answer\": \"LLM generated answer\",\n  \"question\": \"original question\",\n  \"refs\": [referenced document info],\n  \"session_id\": \"session ID\",\n  \"thread_id\": \"thread ID\",\n  \"id\": \"unique answer ID (optional)\"\n}"
    },
    {
      "parameters": {
        "jsCode": "// Upsert defaults processing\nconst b = $json;\nconst session_id = (b.session_id !== undefined && b.session_id !== null) ? b.session_id : null;\nconst thread_id = (b.thread_id !== undefined && b.thread_id !== null) ? b.thread_id : null;\nconst answer = String(b.answer || '').slice(0, 8000);\nconst question = String(b.question || '').slice(0, 4000);\nconst refs = Array.isArray(b.refs) ? b.refs : [];\nconst id = b.id || String(Date.now());\nreturn [{ json: { session_id: session_id, thread_id: thread_id, answer: answer, question: question, refs: refs, id: id } }];"
      },
      "id": "4656cf42-6fcb-447c-95c7-66571b958b71",
      "name": "Fn Upsert Defaults",
      "position": [
        -1920,
        176
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "notes": "ì—…ì„œíŠ¸ ë°ì´í„° ì²˜ë¦¬ / Upsert Data Processing\n\ní•œê¸€:\n- ë‹µë³€ í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ (ìµœëŒ€ 8000ì)\n- ì§ˆë¬¸ í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ (ìµœëŒ€ 4000ì)\n- IDê°€ ì—†ìœ¼ë©´ í˜„ì¬ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©\n- ì„¸ì…˜/ìŠ¤ë ˆë“œ ID ì²˜ë¦¬\n- ì°¸ì¡° ë¬¸ì„œ ì •ë³´ ì²˜ë¦¬\n\nEnglish:\n- Limit answer text length (max 8000 chars)\n- Limit question text length (max 4000 chars)\n- Use current timestamp if no ID provided\n- Handle session/thread IDs\n- Process reference document info"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.TEI_EMBED_URL + '/embed' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { inputs: [ $json.answer ] } }}",
        "options": {}
      },
      "id": "de518966-ef57-4ce9-92ee-d225a1024721",
      "name": "HTTP TEI Embed (answer)",
      "position": [
        -1680,
        112
      ],
      "retryOnFail": true,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "onError": "continueRegularOutput",
      "notes": "ë‹µë³€ ì„ë² ë”© ë³€í™˜ / Answer Embedding Conversion\n\ní•œê¸€:\n- LLM ë‹µë³€ì„ ë²¡í„°ë¡œ ë³€í™˜í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤€ë¹„\n- ê°™ì€ TEI ì„ë² ë”© ì„œë²„ ì‚¬ìš©\n- í–¥í›„ ì´ ë‹µë³€ì´ ë‹¤ë¥¸ ì§ˆë¬¸ì˜ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©ë  ìˆ˜ ìˆìŒ\n\nEnglish:\n- Convert LLM answer to vector for database storage\n- Uses same TEI embedding server\n- This answer can be used as context for future questions"
    },
    {
      "parameters": {
        "mode": "combine",
        "options": {}
      },
      "id": "613072c9-7d13-4fe1-a8fa-ece8439caaf1",
      "name": "Merge Upsert Defaults+Embed",
      "position": [
        -1456,
        176
      ],
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "notes": "ì—…ì„œíŠ¸ ê¸°ë³¸ê°’ê³¼ ì„ë² ë”© ê²°í•© / Merge Upsert Defaults with Embedding\n\ní•œê¸€: ì²˜ë¦¬ëœ ì—…ì„œíŠ¸ ë°ì´í„°ì™€ ë‹µë³€ ì„ë² ë”©ì„ ê²°í•©\nEnglish: Combine processed upsert data with answer embedding"
    },
    {
      "parameters": {
        "jsCode": "// Build Qdrant point\nconst j = $json;\nconst vector = (j.embeddings && j.embeddings[0]) ? j.embeddings[0] : ((j.data && j.data[0] && j.data[0].embedding) ? j.data[0].embedding : []);\nconst point = {\n  id: j.id,\n  vector: vector,\n  payload: {\n    session_id: j.session_id,\n    thread_id: j.thread_id,\n    role: 'assistant',\n    ts: Date.now(),\n    text: j.answer,\n    question: j.question,\n    refs: j.refs || []\n  }\n};\nreturn [{ json: { point: point } }];"
      },
      "id": "ed2bcaa0-f4a8-44d8-b3ca-cbbb7772b460",
      "name": "Fn Build Qdrant Point",
      "position": [
        -1232,
        176
      ],
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueRegularOutput",
      "notes": "Qdrant í¬ì¸íŠ¸ êµ¬ì„± / Qdrant Point Construction\n\ní•œê¸€:\n- Qdrantì— ì €ì¥í•  í¬ì¸íŠ¸ ë°ì´í„° êµ¬ì¡° ìƒì„±\n- vector: ë‹µë³€ì˜ ì„ë² ë”© ë²¡í„°\n- payload: ë©”íƒ€ë°ì´í„° (ì„¸ì…˜ID, ì—­í• , íƒ€ì„ìŠ¤íƒ¬í”„, í…ìŠ¤íŠ¸ ë“±)\n- role: 'assistant' (LLM ë‹µë³€ì„ì„ í‘œì‹œ)\n- ts: ì €ì¥ ì‹œì ì˜ íƒ€ì„ìŠ¤íƒ¬í”„\n\nEnglish:\n- Create point data structure for Qdrant storage\n- vector: embedding vector of the answer\n- payload: metadata (session ID, role, timestamp, text, etc.)\n- role: 'assistant' (indicates LLM answer)\n- ts: timestamp of storage"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.QDRANT_URL + '/collections/' + $env.QDRANT_COLLECTION + '/points?wait=true' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { points: [ $json.point ] } }}",
        "options": {}
      },
      "id": "5e3d773e-e4b7-4118-b0f9-02ee18ab88e5",
      "name": "HTTP Qdrant Upsert",
      "position": [
        -992,
        176
      ],
      "retryOnFail": true,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "onError": "continueRegularOutput",
      "notes": "ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ / Vector Database Storage\n\ní•œê¸€:\n- êµ¬ì„±ëœ í¬ì¸íŠ¸ë¥¼ Qdrant ì»¬ë ‰ì…˜ì— ì €ì¥\n- wait=true: ì €ì¥ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°\n- ê¸°ì¡´ IDê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±\n- ì´ ë°ì´í„°ëŠ” í–¥í›„ RAG ê²€ìƒ‰ì—ì„œ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©ë¨\n\nEnglish:\n- Store constructed point in Qdrant collection\n- wait=true: wait until storage is complete\n- Update if ID exists, create new if not\n- This data will be used as context in future RAG searches"
    },
    {
      "parameters": {
        "options": {
          "responseCode": {
            "values": {
              "responseCode": 200
            }
          }
        }
      },
      "id": "b0ea1d4e-674a-43db-94d6-9c91d7133b68",
      "name": "Respond Upsert",
      "position": [
        -784,
        176
      ],
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "onError": "continueRegularOutput",
      "notes": "ì—…ì„œíŠ¸ ì™„ë£Œ ì‘ë‹µ / Upsert Completion Response\n\ní•œê¸€:\n- ì—…ì„œíŠ¸ ì‘ì—… ì™„ë£Œë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ì•Œë¦¼\n- ì„±ê³µ ì‹œ { \"ok\": true, \"upserted\": 1 } ë°˜í™˜\n- HTTP 200 ìƒíƒœ ì½”ë“œ\n\nEnglish:\n- Notify client of upsert operation completion\n- Returns { \"ok\": true, \"upserted\": 1 } on success\n- HTTP 200 status code"
    },
    {
      "parameters": {
        "mode": "combine",
        "options": {}
      },
      "id": "5b2eb85b-5541-45b7-b9c2-570c3fdd56ce",
      "name": "Merge +Defaults (prepare)",
      "position": [
        -784,
        -208
      ],
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "notes": "ì¤€ë¹„ ë‹¨ê³„ ê¸°ë³¸ê°’ ì „ë‹¬ / Pass Prepare Stage Defaults\n\ní•œê¸€: ê²€ìƒ‰ ì„¤ì •ê°’ì„ í›„ì† ë‹¨ê³„ë¡œ ì „ë‹¬\nEnglish: Pass search settings to subsequent stages"
    },
    {
      "parameters": {
        "content": "# ğŸ“š RAG ì›Œí¬í”Œë¡œìš° ì‚¬ìš©ë²• / RAG Workflow Usage Guide\n\n## ğŸš€ ë¹ ë¥¸ ì‹œì‘ / Quick Start\n\n### í™˜ê²½ ë³€ìˆ˜ ì„¤ì • / Environment Variables\n```bash\nTEI_EMBED_URL=http://localhost:8080      # ì„ë² ë”© ì„œë²„\nTEI_RERANK_URL=http://localhost:8081     # ì¬ë­í‚¹ ì„œë²„\nQDRANT_URL=http://localhost:6333         # Qdrant ë²¡í„° DB\nQDRANT_COLLECTION=documents              # ì»¬ë ‰ì…˜ ì´ë¦„\n```\n\n### ğŸ“ API ì—”ë“œí¬ì¸íŠ¸ / Endpoints\n\n#### 1. ë¬¸ì„œ ê²€ìƒ‰ (RAG Prepare)\n```bash\nPOST /rag/prepare\n{\n  \"query\": \"ê²€ìƒ‰í•  ì§ˆë¬¸\",\n  \"topk\": 12,\n  \"topn\": 5,\n  \"score_threshold\": 0.2\n}\n```\n\n#### 2. ë‹µë³€ ì €ì¥ (RAG Upsert)\n```bash\nPOST /rag/upsert\n{\n  \"answer\": \"LLM ìƒì„± ë‹µë³€\",\n  \"question\": \"ì›ë³¸ ì§ˆë¬¸\",\n  \"refs\": [\"ì°¸ì¡° ë¬¸ì„œë“¤\"]\n}\n```\n\n## ğŸ”„ ì›Œí¬í”Œë¡œìš° íë¦„ / Workflow Flow\n1. ğŸ” **ê²€ìƒ‰**: ì§ˆë¬¸ â†’ ì„ë² ë”© â†’ ë²¡í„° ê²€ìƒ‰ â†’ ì¬ë­í‚¹ â†’ ì»¨í…ìŠ¤íŠ¸ ë°˜í™˜\n2. ğŸ’¾ **ì €ì¥**: ë‹µë³€ â†’ ì„ë² ë”© â†’ ë²¡í„° DB ì €ì¥\n\n## âš™ï¸ ì£¼ìš” ì„¤ì • / Key Settings\n- **topk**: ë²¡í„° ê²€ìƒ‰í•  ë¬¸ì„œ ìˆ˜ (1-64)\n- **topn**: ìµœì¢… ë°˜í™˜í•  ë¬¸ì„œ ìˆ˜\n- **score_threshold**: ìµœì†Œ ìœ ì‚¬ë„ ì ìˆ˜\n\në” ìì„¸í•œ ë‚´ìš©ì€ workflows/README.md ì°¸ì¡° ğŸ“–",
        "height": 1124,
        "width": 528
      },
      "id": "sticky-note-readme",
      "name": "README - RAG ì›Œí¬í”Œë¡œìš° ì‚¬ìš©ë²•",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2880,
        -560
      ]
    }
  ],
  "connections": {
    "WH Prepare": {
      "main": [
        [
          {
            "index": 0,
            "node": "Fn Prepare Defaults",
            "type": "main"
          }
        ]
      ]
    },
    "Fn Prepare Defaults": {
      "main": [
        [
          {
            "index": 0,
            "node": "HTTP TEI Embed (query)",
            "type": "main"
          }
        ]
      ]
    },
    "HTTP TEI Embed (query)": {
      "main": [
        [
          {
            "index": 0,
            "node": "HTTP Qdrant Search",
            "type": "main"
          }
        ]
      ]
    },
    "HTTP Qdrant Search": {
      "main": [
        [
          {
            "index": 0,
            "node": "Fn Doc Collect",
            "type": "main"
          }
        ]
      ]
    },
    "Fn Doc Collect": {
      "main": [
        [
          {
            "index": 0,
            "node": "HTTP TEI Rerank",
            "type": "main"
          }
        ]
      ]
    },
    "HTTP TEI Rerank": {
      "main": [
        [
          {
            "index": 1,
            "node": "Merge Rerank+Docs",
            "type": "main"
          }
        ]
      ]
    },
    "Merge Rerank+Docs": {
      "main": [
        [
          {
            "index": 0,
            "node": "Merge +Defaults",
            "type": "main"
          }
        ]
      ]
    },
    "Merge +Defaults": {
      "main": [
        [
          {
            "index": 0,
            "node": "Fn Zip+Filter (topN, threshold)",
            "type": "main"
          }
        ]
      ]
    },
    "Fn Zip+Filter (topN, threshold)": {
      "main": [
        [
          {
            "index": 0,
            "node": "Respond Prepare",
            "type": "main"
          }
        ]
      ]
    },
    "WH Upsert": {
      "main": [
        [
          {
            "index": 0,
            "node": "Fn Upsert Defaults",
            "type": "main"
          }
        ]
      ]
    },
    "Fn Upsert Defaults": {
      "main": [
        [
          {
            "index": 0,
            "node": "HTTP TEI Embed (answer)",
            "type": "main"
          }
        ]
      ]
    },
    "HTTP TEI Embed (answer)": {
      "main": [
        [
          {
            "index": 1,
            "node": "Merge Upsert Defaults+Embed",
            "type": "main"
          }
        ]
      ]
    },
    "Merge Upsert Defaults+Embed": {
      "main": [
        [
          {
            "index": 0,
            "node": "Fn Build Qdrant Point",
            "type": "main"
          }
        ]
      ]
    },
    "Fn Build Qdrant Point": {
      "main": [
        [
          {
            "index": 0,
            "node": "HTTP Qdrant Upsert",
            "type": "main"
          }
        ]
      ]
    },
    "HTTP Qdrant Upsert": {
      "main": [
        [
          {
            "index": 0,
            "node": "Respond Upsert",
            "type": "main"
          }
        ]
      ]
    },
    "Merge +Defaults (prepare)": {
      "main": [
        [
          {
            "index": 1,
            "node": "Merge +Defaults",
            "type": "main"
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "f0c88043b37709424fce4a577f8f86cc883a838c35e83507d25d62c957b8fbde"
  }
}